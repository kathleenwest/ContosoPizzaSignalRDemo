<!DOCTYPE html>
<html>
<head>
    <title>Admin Order Updates</title>
    <!-- Include the SignalR library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
</head>
<body>
    <img src="images/pizza_sign.jpg" alt="Conotosa Pizza Sign" width="300" height="200">
    <h1>Pizza Order Admin</h1>

    <p>
        <div id="orderStatus"></div>
    </p>

    <button type="submit" onclick="fetchPizzaOrders()">Get Orders</button>

    <!-- Add a form to submit order updates -->
    <form id="ordersForm">
        <table id="myOrders" cellpadding="5" border="1" cellspacing="5">
        </table>
    </form>

    <script>

        var statusLookupTable = [
            { number: 0, value: 'New' },
            { number: 1, value: 'Received' },
            { number: 2, value: 'Preparation' },
            { number: 3, value: 'Baking' },
            { number: 4, value: 'Out for Delivery' },
            { number: 5, value: 'Complete' }
        ];

        // Function to lookup a value by number
        function statusLookup(number) {
            var item = statusLookupTable.find(function (element) {
                return element.number === number;
            });
            return item ? item.value : 'Not found';
        }

        // Create a new connection to the SignalR hub
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("https://localhost:7048/ordersHub")
            .configureLogging(signalR.LogLevel.Information)
            .build();

        // Function to start the SignalR connection
        // Start the connection
        async function start() {
            try {
                await connection.start();
                console.log("SignalR Connected.");
            } catch (err) {
                console.log(err);
                setTimeout(start, 5000);
            }
        };

        connection.onclose(async () => {
            await start();
        });

        var connectionIdValue;

        // Start the connection
        start().then(() => {
            connectionIdValue = connection.connectionId;
            // Send this connectionId back to the server to map it with the new order
        });

        // Function to handle order updates from the server
        connection.on("ReceiveAdminOrderUpdate", function (update) {
            console.log("Received Order Update");
            const statusDiv = document.getElementById("orderStatus");
            statusDiv.innerHTML = update;
            fetchPizzaOrders();

        });

        window.onload = function () {
            // Fetch the Pizza Orders
            fetchPizzaOrders();
        };

        // Get the PizzaOrders
        async function fetchPizzaOrders() {
            try {

                // Clear the Orders Table
                document.getElementById("myOrders").replaceChildren();

                const response = await fetch('https://localhost:7048/api/Order');
                const data = await response.json();
                //console.log(data);

                // Setup the Orders Table Header
                var thead = document.createElement("thead");
                var tr = document.createElement("tr");

                var th = document.createElement("th");
                var text = document.createTextNode("Order Id");
                th.appendChild(text);
                tr.appendChild(th);

                var th = document.createElement("th");
                var text = document.createTextNode("Customer Name");
                th.appendChild(text);
                tr.appendChild(th);

                var th = document.createElement("th");
                var text = document.createTextNode("Pizza Details");
                th.appendChild(text);
                tr.appendChild(th);

                var th = document.createElement("th");
                var text = document.createTextNode("Status");
                th.appendChild(text);
                tr.appendChild(th);

                var th = document.createElement("th");
                var text = document.createTextNode("Update Status");
                th.appendChild(text);
                tr.appendChild(th);

                thead.appendChild(tr);
                document.getElementById("myOrders").appendChild(thead);

                // Lopp Through the Order Status
                data.forEach(function (item) {

                    var tr = document.createElement("tr");

                    var td = document.createElement("td");
                    var text = document.createTextNode(item.orderId);
                    td.appendChild(text);
                    tr.appendChild(td);

                    var td = document.createElement("td");
                    var text = document.createTextNode(item.customerName);
                    td.appendChild(text);
                    tr.appendChild(td);

                    var td = document.createElement("td");
                    var text = document.createTextNode(item.pizza.pizzaDetails);
                    td.appendChild(text);
                    tr.appendChild(td);

                    var td = document.createElement("td");
                    var text = document.createTextNode(statusLookup(item.status));
                    td.appendChild(text);
                    tr.appendChild(td);

                    var td = document.createElement("td");
                    // Create the select element
                    var selectElement = document.createElement('select');
                    selectElement.id = 'mySelect';

                    // Populate the select element with options from the lookup table
                    statusLookupTable.forEach(function (item) {
                        var option = document.createElement('option');
                        option.value = item.number;
                        option.text = item.value;
                        selectElement.appendChild(option);
                    });
                    td.appendChild(selectElement);

                    var buttonElement = document.createElement('button');
                    buttonElement.id = 'orderChangeButton';
                    buttonElement.textContent = 'Update';
                    buttonElement.addEventListener('click', function () {
                        alert('Button clicked!');
                    });
                    td.appendChild(buttonElement);

                    tr.appendChild(td);

                    document.getElementById("myOrders").appendChild(tr);
                });

                return data;
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        };


        // Handle the form submission
        //document.getElementById("ordersForm").addEventListener("submit", function (e) {
        //    e.preventDefault();

        //    const customerNameValue = document.getElementById("CustomerName").value;
        //    const pizzaDetailsValue = document.getElementById("PizzaDetails").value;

        //    const order = {
        //        "customerName": customerNameValue,
        //        "pizza": {
        //            "pizzaDetails": pizzaDetailsValue
        //        },
        //        "connectionId": connectionIdValue
        //    };

        //    // Send the order details to the server
        //    fetch('https://localhost:7048/api/Order',
        //        {
        //            method: 'POST',
        //            headers: {
        //                'Content-Type': 'application/json'
        //            },
        //            body: JSON.stringify(order)
        //        })
        //        .then(response => response.json())
        //        .then(data => console.log('Order submitted:', data))
        //        .catch(error => console.error('Error:', error));
        //});

    </script>
</body>
</html>
